<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/post_dream.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <title>Editar Sonho | Sonholândia</title>
</head>
<body>
    <header>
        <nav>
            <a href="{{ url_for('dreams.view_dream', dream_id=dream.id) }}" class="back-link">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </nav>
    </header>

    <main>
        <section class="post-container">
            <h1>Editar Sonho</h1>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form id="dreamForm" action="{{ url_for('dreams.edit_dream', dream_id=dream.id) }}" method="POST" enctype="multipart/form-data">
                <!-- Barra de Progresso -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>

                <!-- Título -->
                <div class="form-group">
                    <label for="title">Título do Sonho *</label>
                    <input 
                        type="text" 
                        id="title" 
                        name="title" 
                        value="{{ dream.title }}"
                        required
                        maxlength="100"
                    >
                </div>

                <!-- Descrição -->
                <div class="form-group">
                    <label for="description">Descrição do Sonho *</label>
                    <textarea 
                        id="description" 
                        name="description" 
                        rows="8" 
                        required
                        maxlength="5000"
                    >{{ dream.description }}</textarea>
                    <span class="char-count"><span id="charCount">{{ dream.description|length }}</span>/5000</span>
                </div>

                <!-- Tipo de Sonho -->
                <div class="form-group">
                    <label for="dream_type">Tipo de Sonho *</label>
                    <select id="dream_type" name="dream_type" required>
                        <option value="">Selecione o tipo...</option>
                        <option value="lucido" {% if dream.dream_type == 'lucido' %}selected{% endif %}>Lúcido</option>
                        <option value="molhado" {% if dream.dream_type == 'molhado' %}selected{% endif %}>Molhado</option>
                        <option value="pesadelo" {% if dream.dream_type == 'pesadelo' %}selected{% endif %}>Pesadelo</option>
                        <option value="recorrente" {% if dream.dream_type == 'recorrente' %}selected{% endif %}>Recorrente</option>
                        <option value="vivido" {% if dream.dream_type == 'vivido' %}selected{% endif %}>Vivido</option>
                        <option value="estranho" {% if dream.dream_type == 'estranho' %}selected{% endif %}>Estranho</option>
                        <option value="agradavel" {% if dream.dream_type == 'agradavel' %}selected{% endif %}>Agradável</option>
                        <option value="outro" {% if dream.dream_type == 'outro' %}selected{% endif %}>Outro</option>
                    </select>
                </div>

                <!-- Tags -->
                <div class="form-group">
                    <label for="tags">Tags (Hashtags)</label>
                    <input 
                        type="text" 
                        id="tags" 
                        name="tags" 
                        value="{% for tag in tags %}#{{ tag }} {% endfor %}"
                        placeholder="Ex: #casa #familia #aventura"
                    >
                    <small class="help-text">Separe as tags por espaço ou vírgula. O símbolo # será adicionado automaticamente.</small>
                </div>

                <!-- Imagem -->
                <div class="form-group">
                    <label for="image">Imagem do Sonho (Opcional)</label>
                    {% if dream.image_path %}
                    <div style="margin-bottom: 1rem;">
                        <p>Imagem atual:</p>
                        <img src="{{ url_for('static', filename=dream.image_path) }}" alt="Imagem atual" style="max-width: 200px; border-radius: 8px;">
                    </div>
                    {% endif %}
                    <input 
                        type="file" 
                        id="image" 
                        name="image" 
                        accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
                    >
                    <small class="help-text">Deixe em branco para manter a imagem atual. Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP (máx. 5MB)</small>
                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <!-- Botões -->
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="window.location.href='{{ url_for('dreams.view_dream', dream_id=dream.id) }}'">
                        Cancelar
                    </button>
                    <button type="button" class="btn-delete" onclick="deleteDream({{ dream.id }})">
                        <i class="bi bi-trash"></i> Deletar
                    </button>
                    <button type="submit" class="btn-submit" id="submitBtn">
                        <i class="bi bi-save"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </section>
    </main>

    <script src="{{ url_for('static', filename='js/post_dream.js') }}"></script>
    <script>
        function deleteDream(dreamId) {
            if (confirm('Tem certeza que deseja deletar este sonho? Esta ação não pode ser desfeita.')) {
                fetch(`/deletar-sonho/${dreamId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/feed';
                    } else {
                        alert('Erro ao deletar sonho: ' + (data.error || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao deletar sonho. Tente novamente.');
                });
            }
        }
    </script>
</body>
</html>

